---
import type { CollectionEntry } from "astro:content"
import FormattedDate from "./FormattedDate.astro"
import CategoryBadge from "./CategoryBadge.astro"

type Props = CollectionEntry<"reports"> & { featured?: boolean }

const { featured = false, slug, render, data = {}, id, body } = Astro.props
const { remarkPluginFrontmatter, Content } = await render()

const images: Record<string, { default: ImageMetadata }> = import.meta.glob(
  "../images/*.{jpg,jpeg,png}",
  { eager: true },
)

function getImageUrl(image: string) {
  const key = Object.keys(images).find((key) => key.includes(image))
  if (!key) return ""
  return images[key]?.default?.src || ""
}
---

<a
  href={`/reports/${slug}`}
  class:list={[
    "listing group col-span-full w-full rounded-xl transition-all",
    {
      ["lg:col-span-full"]: featured,
      ["lg:col-span-5"]: !featured,
    },
  ]}
>
  <article class:list={["flex w-full flex-col", { ["lg:flex-row"]: featured }]}>
    <div
      class:list={[
        "image relative",
        {
          ["basis-2/3"]: featured,
        },
      ]}
    >
      {data.category && <CategoryBadge id={id} category={data.category} />}
      <img
        transition:name={`image-${data.image}`}
        src={getImageUrl(data.image)}
        alt=""
        class:list={[
          "z-10 aspect-video w-full rounded-lg border border-gray-800 object-cover shadow-lg transition-all duration-200 group-hover:scale-[1.0125] group-hover:shadow-2xl md:h-60",
          { ["md:h-80"]: featured },
        ]}
      />
      {
        /* {{ if hasPrefix .Params.image "http"}}
              <img src="{{ .Params.image }}" alt="">
              {{ else }}
              {{ partial "site/img" (dict "image" .Params.image "width" 458 "height" 240) }}
              {{ end }} */
      }
    </div>
    <div
      class:list={[
        "content rounded-b-lg rounded-l-lg p-6 pt-4 text-foreground transition-all group-hover:bg-black/20 lg:mb-2 lg:pt-8",
        { ["basis-1/3 rounded-bl-none rounded-tl-none"]: featured },
      ]}
    >
      <h2
        class="title m-0 text-2xl font-semibold"
        transition:name={`title-${id}`}
      >
        {data.title}
      </h2>
      {
        data.date instanceof Date && (
          <span class="date" transition:name={`date-${id}`}>
            <FormattedDate date={data.date} />
          </span>
        )
      }
      <!-- <p class="excerpt"><Content /></p> -->
      <span
        transition:name={`readtime-${id}`}
        class="time-to-read text-accent-500 mt-3 block whitespace-nowrap text-sm"
      >
        {remarkPluginFrontmatter.minutesRead}
      </span>
    </div>
  </article>
</a>
